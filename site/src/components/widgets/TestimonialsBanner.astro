---
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import type { Testimonials as Props } from '~/types';

const {
  title = '',
  subtitle = '',
  tagline = '',
  testimonials = [],

  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

---

<WidgetWrapper id={id} isDark={isDark} containerClass={`testimonial-carousel max-w-6xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
	<Headline title={title} subtitle={subtitle} tagline={tagline} classes={{ container: 'mb-4 md:mb-4' }}/>
	<div class="testimonial-carousel grid grid-cols-1">
		<div class="testimonial-content">
	       { 
	       testimonials.map(({ testimonial, name, job, company}, index) => (
	        <div class="testimonial-slide flex h-auto bg-white dark:bg-dark" data-index={index}>
	          <div class="testimonial-quote flex flex-col p-4 md:p-6 rounded-md shadow-xl dark:shadow-none dark:border dark:border-slate-600">
				<p class="quote-text">"{testimonial}"</p>
	            <div class="grow ml-3 rtl:ml-0 rtl:mr-3">
	              {(name || company) && (
	                <p class="text-base">
	                  {name && <span class="font-semibold">{name}</span>}
	                  {name && company && <span class="mx-1 text-muted">|</span>}
	                  {company && <span class="font-normal">{company}</span>}
	                </p>
	              )}
	              {job && <p class="text-xs text-muted">{job}</p>}
	            </div>
						</div>
					</div>
				))}
			</div>
			<div class="carousel-dots">
				{testimonials.map((_, index) => (
					<button class="dot" data-index={index} aria-label={`Go to testimonial ${index + 1}`}></button>
				))}
			</div>
		</div>
</WidgetWrapper>

<script>
  // A variable to hold the interval so we can clear it later
  let autoplayInterval;

  // 1. Wrap all of your logic in an initialization function.
  function initCarousel() {
    // Stop any previously running intervals to be safe
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
    }

    const slides = document.querySelectorAll('.testimonial-slide') as NodeListOf<HTMLElement>;
    const dots = document.querySelectorAll('.carousel-dots .dot') as NodeListOf<HTMLElement>;
    
    // Exit if the carousel isn't on the current page
    if (slides.length === 0) {
      return;
    }

    let currentIndex = 0;
    const totalSlides = slides.length;
    const autoplayDelay = 5000;

    function showSlide(index) {
      currentIndex = (index + totalSlides) % totalSlides;

      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === currentIndex);
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }

    function nextSlide() {
      showSlide(currentIndex + 1);
    }

    function startAutoplay() {
      autoplayInterval = window.setInterval(nextSlide, autoplayDelay);
    }

    function stopAutoplay() {
      clearInterval(autoplayInterval);
    }

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        stopAutoplay();
        showSlide(index);
        startAutoplay();
      });
    });

    showSlide(0);
    startAutoplay();
  }

  // 2. Run the function on the 'astro:page-load' event.
  document.addEventListener('astro:page-load', initCarousel);

  // 3. (Best Practice) Clean up the interval before the page changes.
  document.addEventListener('astro:before-swap', () => {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
    }
  });
</script>

<style>
	.testimonial-carousel {
		position: relative;
		margin: 0 auto;
	}

	.testimonial-content {
		position: relative;
		min-height: 300px;
	}

	.testimonial-slide {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
	}

	.testimonial-slide.active {
		opacity: 1;
		visibility: visible;
		position: relative;
	}

	.testimonial-quote {
		padding: 2rem;
	}

	.quote-text {
		color: var(--white);
		font-style: italic;
		font-size: 1.2rem;
		line-height: 1.8;
		margin-bottom: 2rem;
	}

	.carousel-dots {
		display: flex;
		justify-content: center;
		gap: 0.75rem;
		margin-top: 2rem;
	}

	.dot {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		background: rgba(75, 110, 234, 0.3);
		border: none;
		cursor: pointer;
		transition: all 0.3s ease;
		padding: 0;
	}

	.dot:hover {
		background: rgba(23, 12, 143, 0.5);
		transform: scale(1.3);
	}

	.dot.active {
		background: rgba(23, 12, 143, 0.5);
		transform: scale(1.5);
	}

	@media (max-width: 768px) {
		.testimonial-carousel {
			padding: 0 3rem;
		}

		.quote-text {
			font-size: 1rem;
		}

		.testimonial-content {
			min-height: 350px;
		}
	}

	@media (max-width: 480px) {
		.testimonial-carousel {
			padding: 0 2.5rem;
		}

		.quote-text {
			font-size: 0.95rem;
		}
	}
</style>